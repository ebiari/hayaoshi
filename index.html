<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>早押しクイズ連携アプリ - 7台対応</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Firebase App (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Babel for JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>

    <script type="text/babel">
        /**
         * Firebase Configuration
         * Renderなどでホストする場合、ここにFirebaseコンソールから取得した設定を貼り付けてください。
         */
        let firebaseConfig = {
           apiKey: "AIzaSyC1SLnvP06t6zDJKwSYBEMLCLjk4QQCwyg",
  authDomain: "hayaoshi-a8ae5.firebaseapp.com",
  projectId: "hayaoshi-a8ae5",
  storageBucket: "hayaoshi-a8ae5.firebasestorage.app",
  messagingSenderId: "402004098948",
  appId: "1:402004098948:web:b877c790b2872af56ba7d1",
  measurementId: "G-B0PNB80BWW"
        };
        
        // 環境変数からの読み込み（Canvas/Renderなどの自動注入対応）
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) { console.warn("Environment config not found, using manual config."); }
        
        // Firebase初期化フラグ
        const isConfigValid = firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY";
        
        if (isConfigValid && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        // アプリID（データの保存場所を分けるためのキー）
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hayaoshi-quiz-render-v1';

        const { useState, useEffect } = React;

        // アイコン表示補助コンポーネント
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [gameState, setGameState] = useState({ isActive: false, lastReset: Date.now() });
            const [results, setResults] = useState([]);
            const [role, setRole] = useState(null);
            const [userName, setUserName] = useState('');
            const [hasPushed, setHasPushed] = useState(false);
            const [error, setError] = useState(null);

            // 認証ロジック
            useEffect(() => {
                if (!isConfigValid) {
                    setError("Firebase設定が未完了です。コード内の firebaseConfig を更新してください。");
                    return;
                }

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            // 匿名認証。Firebaseコンソールで「匿名認証」の有効化が必要
                            await auth.signInAnonymously();
                        }
                    } catch (err) {
                        console.error("Auth Error:", err);
                        if (err.code === 'auth/operation-not-allowed') {
                            setError("Firebaseコンソールで『匿名認証』を有効にしてください。");
                        } else {
                            setError(`接続失敗: ${err.message}`);
                        }
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // リアルタイムデータ同期
            useEffect(() => {
                if (!user) return;

                // ゲーム状態の監視
                const gameDocRef = db.doc(`artifacts/${appId}/public/data/control/state`);
                const unsubscribeControl = gameDocRef.onSnapshot((snapshot) => {
                    if (snapshot.exists) {
                        const data = snapshot.data();
                        setGameState(data);
                        if (data.isActive) setHasPushed(false);
                    } else {
                        // 初期ドキュメント作成
                        gameDocRef.set({ isActive: false, lastReset: Date.now() }).catch(console.error);
                    }
                }, (err) => {
                    console.error("Firestore Listen Error:", err);
                    setError("Firestoreの権限（セキュリティルール）を確認してください。");
                });

                // 結果リストの監視
                const resultsColRef = db.collection(`artifacts/${appId}/public/data/results`);
                const unsubscribeResults = resultsColRef.onSnapshot((snapshot) => {
                    const docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    const sorted = docs.sort((a, b) => a.timestamp - b.timestamp);
                    setResults(sorted);
                }, (err) => console.error("Results Sync Error:", err));

                return () => {
                    unsubscribeControl();
                    unsubscribeResults();
                };
            }, [user]);

            const handleJoin = (selectedRole) => {
                if (!userName.trim()) return;
                setRole(selectedRole);
            };

            const pushBuzzer = async () => {
                if (!user || !gameState.isActive || hasPushed || role !== 'player') return;
                const pushTime = Date.now();
                setHasPushed(true);
                try {
                    const resultDocRef = db.doc(`artifacts/${appId}/public/data/results/${user.uid}`);
                    await resultDocRef.set({
                        userId: user.uid,
                        name: String(userName),
                        timestamp: Number(pushTime),
                        diff: Number(pushTime - gameState.lastReset)
                    });
                } catch (err) {
                    console.error("Push failed:", err);
                    setHasPushed(false);
                }
            };

            const startNewRound = async () => {
                if (role !== 'host' || !user) return;
                try {
                    // 古い結果の削除
                    const resultsColRef = db.collection(`artifacts/${appId}/public/data/results`);
                    const snapshot = await resultsColRef.get();
                    const batch = db.batch();
                    snapshot.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();

                    // 状態の更新
                    const gameDocRef = db.doc(`artifacts/${appId}/public/data/control/state`);
                    await gameDocRef.update({ isActive: true, lastReset: Date.now() });
                } catch (err) {
                    console.error("Round Start Error:", err);
                }
            };

            const deactivateBuzzer = async () => {
                if (role !== 'host' || !user) return;
                const gameDocRef = db.doc(`artifacts/${appId}/public/data/control/state`);
                await gameDocRef.update({ isActive: false });
            };

            const getRank = () => {
                const idx = results.findIndex(r => r.userId === user?.uid);
                return idx !== -1 ? idx + 1 : null;
            };

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 bg-slate-900 text-white">
                        <div className="max-w-md w-full p-8 bg-slate-800 border-t-4 border-red-500 rounded-2xl shadow-2xl">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-red-500">
                                <Icon name="alert-circle" />
                                エラー
                            </h2>
                            <p className="text-slate-400 text-sm mb-6 font-mono p-4 bg-slate-900 rounded-lg border border-slate-700">
                                {error}
                            </p>
                            <button onClick={() => window.location.reload()} className="w-full py-3 bg-red-600 hover:bg-red-500 rounded-xl font-bold transition-all shadow-lg active:scale-95">
                                再接続
                            </button>
                        </div>
                    </div>
                );
            }

            if (!role) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 bg-slate-900 text-white">
                        <div className="w-full max-w-md bg-slate-800 rounded-3xl p-8 shadow-2xl border border-slate-700 transition-all duration-500 animate-in fade-in zoom-in">
                            <div className="flex flex-col items-center mb-10">
                                <div className="p-4 bg-yellow-400 rounded-2xl mb-4 shadow-lg shadow-yellow-400/20">
                                    <Icon name="zap" size={32} className="text-slate-900 fill-current" />
                                </div>
                                <h1 className="text-3xl font-black tracking-tighter italic">QUIZ BUZZER</h1>
                                <p className="text-slate-500 text-xs mt-2 font-bold uppercase tracking-widest">Connect & Compete</p>
                            </div>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-[10px] font-bold text-slate-500 mb-2 ml-1 uppercase">Nickname</label>
                                    <input 
                                        type="text" 
                                        maxLength={12}
                                        value={userName}
                                        onChange={(e) => setUserName(e.target.value)}
                                        placeholder="名前を入力"
                                        className="w-full bg-slate-900 border border-slate-700 rounded-xl py-4 px-4 text-white text-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-slate-700"
                                    />
                                </div>
                                <div className="grid grid-cols-2 gap-4 pt-2">
                                    <button onClick={() => handleJoin('player')} disabled={!userName.trim()}
                                        className="group flex flex-col items-center justify-center gap-2 p-6 bg-slate-700 hover:bg-blue-600 disabled:opacity-20 rounded-2xl transition-all shadow-lg active:scale-95">
                                        <Icon name="user" size={28} />
                                        <span className="font-bold text-xs uppercase">Player</span>
                                    </button>
                                    <button onClick={() => handleJoin('host')} disabled={!userName.trim()}
                                        className="group flex flex-col items-center justify-center gap-2 p-6 bg-slate-700 hover:bg-purple-600 disabled:opacity-20 rounded-2xl transition-all shadow-lg active:scale-95">
                                        <Icon name="crown" size={28} />
                                        <span className="font-bold text-xs uppercase">Host</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const rankValue = getRank();

            return (
                <div className="min-h-screen flex flex-col bg-slate-900 text-white">
                    {/* Header */}
                    <header className="bg-slate-800/80 backdrop-blur-md border-b border-slate-700 p-4 sticky top-0 z-20 flex justify-between items-center px-6">
                        <div className="flex items-center gap-4">
                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center shadow-lg ${role === 'host' ? 'bg-purple-600' : 'bg-blue-600'}`}>
                                <Icon name={role === 'host' ? 'crown' : 'user'} size={20} className="fill-current" />
                            </div>
                            <div>
                                <div className="font-black text-lg leading-none mb-1 tracking-tight truncate max-w-[120px]">{userName}</div>
                                <div className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">{role} mode</div>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-4">
                            <div className={`px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 text-[10px] font-black flex items-center gap-2 ${gameState.isActive ? 'text-green-400' : 'text-red-400'}`}>
                                <div className={`w-2 h-2 rounded-full ${gameState.isActive ? 'bg-green-400 animate-pulse' : 'bg-red-400'}`} />
                                {gameState.isActive ? 'ACTIVE' : 'IDLE'}
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col lg:flex-row p-4 md:p-6 gap-6 overflow-hidden">
                        
                        {/* Center Area (Button or Controls) */}
                        <div className="flex-[3] flex flex-col items-center justify-center bg-slate-800/50 rounded-[2.5rem] p-6 border border-slate-700/50 shadow-2xl relative">
                            {role === 'player' ? (
                                <div className="flex flex-col items-center gap-8">
                                    <div className="relative">
                                        <button 
                                            onPointerDown={pushBuzzer} 
                                            disabled={!gameState.isActive || hasPushed}
                                            className={`
                                                relative w-64 h-64 md:w-80 md:h-80 rounded-full transition-all duration-75 select-none touch-none flex items-center justify-center active:translate-y-[12px] active:shadow-none
                                                ${!gameState.isActive 
                                                    ? 'bg-slate-700 text-slate-800 cursor-not-allowed border-b-8 border-slate-900' 
                                                    : hasPushed 
                                                        ? 'bg-green-600 border-none translate-y-[12px] text-green-200' 
                                                        : 'bg-red-600 hover:bg-red-500 border-b-[20px] border-red-800 active:border-b-0'
                                                }
                                            `}
                                        >
                                            <div className="text-6xl md:text-8xl font-black italic tracking-tighter drop-shadow-2xl">
                                                {hasPushed ? 'PUSHED' : 'PUSH'}
                                            </div>
                                        </button>
                                        
                                        {/* Glow Effect */}
                                        {gameState.isActive && !hasPushed && (
                                            <div className="absolute -inset-8 bg-red-600/10 rounded-full blur-3xl -z-10 animate-pulse" />
                                        )}
                                    </div>
                                    
                                    <div className="text-center bg-slate-900/50 px-8 py-4 rounded-2xl border border-slate-700/50">
                                        <p className={`text-xl font-black tracking-[0.2em] italic transition-colors ${gameState.isActive ? 'text-green-400' : 'text-slate-600'}`}>
                                            {gameState.isActive ? 'GO! GO! GO!' : 'READY...'}
                                        </p>
                                        {hasPushed && rankValue && (
                                            <div className="text-5xl font-black text-yellow-400 mt-4 animate-bounce flex items-center justify-center gap-3 italic drop-shadow-lg">
                                                RANK #{rankValue}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ) : (
                                <div className="w-full max-w-lg space-y-12">
                                    <div className="text-center">
                                        <h2 className="text-3xl font-black tracking-tight italic uppercase flex items-center justify-center gap-3">
                                            <Icon name="cog" className="text-purple-400" size={32} />
                                            Admin Panel
                                        </h2>
                                    </div>
                                    
                                    <div className="grid gap-6">
                                        <button 
                                            onClick={startNewRound} 
                                            className="group py-12 bg-green-600 hover:bg-green-500 rounded-3xl font-black text-3xl flex items-center justify-center gap-6 transition-all shadow-[0_12px_0_0_rgba(22,101,52,1)] active:shadow-none active:translate-y-[12px] active:scale-[0.98]"
                                        >
                                            <Icon name="play" size={40} className="fill-current" />
                                            ROUND START
                                        </button>
                                        
                                        <button 
                                            onClick={deactivateBuzzer} 
                                            className="py-8 bg-slate-700 hover:bg-slate-600 border-2 border-slate-600 rounded-3xl font-black text-xl flex items-center justify-center gap-3 transition-transform active:scale-95"
                                        >
                                            <Icon name="square" size={24} className="fill-current" />
                                            STOP ACCEPTING
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="p-6 bg-slate-900/80 rounded-3xl border border-slate-700 shadow-xl">
                                            <div className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-2">Connected</div>
                                            <div className="text-4xl font-black italic">{results.length} <span className="text-sm text-slate-500 not-italic">/ 7</span></div>
                                        </div>
                                        <div className="p-6 bg-slate-900/80 rounded-3xl border border-slate-700 shadow-xl">
                                            <div className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-2">Status</div>
                                            <div className={`text-2xl font-black italic uppercase ${gameState.isActive ? 'text-green-500' : 'text-red-500'}`}>
                                                {gameState.isActive ? 'ACTIVE' : 'IDLE'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Leaderboard Area */}
                        <div className="flex-[2] bg-slate-800 rounded-[2.5rem] p-8 shadow-2xl border border-slate-700 flex flex-col min-h-[500px]">
                            <div className="flex items-center justify-between mb-10">
                                <h3 className="text-2xl font-black italic uppercase tracking-tighter flex items-center gap-3">
                                    <Icon name="trophy" className="text-yellow-500" /> 
                                    Leaderboard
                                </h3>
                                <div className="text-[10px] font-bold text-slate-500 bg-slate-900 px-3 py-1 rounded-full border border-slate-700">7 SLOTS</div>
                            </div>

                            <div className="flex-1 overflow-y-auto space-y-4 custom-scrollbar pr-2">
                                {results.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-700 italic">
                                        <Icon name="clock-3" size={64} className="mb-4 opacity-20" />
                                        <p className="font-bold uppercase tracking-widest text-sm opacity-50">Waiting for buzzer...</p>
                                    </div>
                                ) : (
                                    results.slice(0, 7).map((res, index) => (
                                        <div 
                                            key={res.id} 
                                            className={`
                                                flex items-center gap-4 p-5 rounded-3xl transition-all animate-in slide-in-from-right-4 duration-300
                                                ${index === 0 
                                                    ? 'bg-gradient-to-r from-yellow-500/20 to-slate-700/50 border-l-8 border-yellow-500 shadow-2xl scale-[1.03]' 
                                                    : 'bg-slate-700/30 border-l-8 border-slate-600'
                                                }
                                            `}
                                        >
                                            <div className={`
                                                w-14 h-14 rounded-2xl flex items-center justify-center font-black text-2xl shadow-inner shrink-0
                                                ${index === 0 ? 'bg-yellow-500 text-slate-900' : 
                                                  index === 1 ? 'bg-slate-300 text-slate-800' : 
                                                  index === 2 ? 'bg-amber-700 text-white' : 
                                                  'bg-slate-600/50 text-slate-400'}
                                            `}>
                                                {index + 1}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="font-black text-xl truncate uppercase tracking-tight">{res.name}</div>
                                                <div className="text-[10px] font-mono text-slate-500 flex items-center gap-2 mt-1 italic font-bold">
                                                    <Icon name="clock" size={12} />
                                                    {index === 0 ? 'WINNER' : `+${((res.timestamp - results[0].timestamp) / 1000).toFixed(3)}s`}
                                                </div>
                                            </div>
                                            {index === 0 && (
                                                <div className="p-3 bg-yellow-500/10 rounded-full">
                                                    <Icon name="star" className="text-yellow-500 fill-current animate-spin-slow" size={24} />
                                                </div>
                                            )}
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </main>
                    
                    {/* Footer Info */}
                    <footer className="p-4 text-center text-[8px] font-bold text-slate-700 uppercase tracking-[0.4em]">
                        Quiz Buzzer Network v1.0 • Render Cloud Hosted
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
